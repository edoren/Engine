# Specify version format
version: "{build}-{branch}"

# Build worker image (VM template)
image: Visual Studio 2015

# build platform, i.e. Win32, x64.
platform:
  - Win32
  - x64

# build configuration, i.e. Debug, Release, etc.
configuration:
  - Debug
  - Release

# scripts that are called at very beginning, before repo cloning
init:
  - echo Vulkan Version %VULKAN_SDK_VERSION%
  - cmake --version
  - msbuild /version

environment:
  PYTHON: "C:\\Python36"

# clone directory
clone_folder: C:\projects\engine

# branches to build
branches:
  except:
    - gh-pages
    - tmp

# scripts that run after cloning repository
install:
  - set PATH=%PYTHON%;%PYTHON%\Scripts;%PATH%
  - git submodule update --init --recursive
  - set PATH=C:\Program Files\Git\mingw64\bin;%PATH% # to get curl
  - curl -fsS -o VulkanSDK.exe https://vulkan.lunarg.com/sdk/download/%VULKAN_SDK_VERSION%/windows/VulkanSDK-%VULKAN_SDK_VERSION%-Installer.exe?human=true
  - start /wait VulkanSDK.exe /S
  - set VULKAN_SDK=C:\VulkanSDK\%VULKAN_SDK_VERSION%
  - set VK_SDK_PATH=%VULKAN_SDK%

# scripts to run before build
before_build:
  - cd C:\projects\engine
  - if "%PLATFORM%"=="Win32" set CMAKE_GENERATOR_PLATFORM=""
  - if "%PLATFORM%"=="x64"   set CMAKE_GENERATOR_PLATFORM="x64"
  - python.exe generate.py --name Engine --package me.edoren.engine --platform windows --build-type %CONFIGURATION% --cmake-args CMAKE_GENERATOR_PLATFORM=%CMAKE_GENERATOR_PLATFORM%
  - cd build\windows

build_script:
  - python.exe build.py

test: on

test_script:
  - cd C:\projects\engine\build\windows\tests
  - ctest -V -C %CONFIGURATION%
